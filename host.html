<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Таинственный дом — Командный квест (Host)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0e11; --panel:#181a20; --muted:#b7bac4; --accent:#ffb703;
    --ghost:#7dd3fc; --hunters:#fca5a5; --ok:#9dffb2; --bad:#ffb4b4; --line:#2b2f39;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; color:#fff; background:var(--bg); font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:16px; position:sticky; top:0; background:#0e0e11e6; backdrop-filter:saturate(130%) blur(6px); z-index:10;
    border-bottom:1px solid #2a2d36;
  }
  h1{margin:0; font-size:clamp(18px,3.4vw,32px); line-height:1.1}
  .btn{border:none; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer}
  .btn.primary{background:var(--accent); color:#000}
  .btn.secondary{background:#252a34; color:#fff}
  .teamTag{display:none; border:1px solid #ffffff1a; border-radius:999px; padding:8px 12px; font-weight:800}
  .teamTag.ghost{display:inline-block; background:color-mix(in oklab, var(--ghost) 20%, #000 80%); color:#e9f9ff}
  .teamTag.hunters{display:inline-block; background:color-mix(in oklab, var(--hunters) 20%, #000 80%); color:#fff2f2}
  .wrap{max-width:980px; margin:20px auto; padding:0 16px}
  .card{
    background:linear-gradient(180deg,#1a1d24 0%,#12151a 100%);
    border:1px solid var(--line); border-radius:18px; overflow:hidden;
    box-shadow:0 20px 80px #0008;
  }
  .roomHero{aspect-ratio:16/9; width:100%; background:#0d0f14 center/cover no-repeat; border-bottom:1px solid var(--line)}
  .roomBody{padding:18px}
  .roomTitle{margin:0 0 8px; font-size:clamp(20px,3vw,28px)}
  .story{color:#e6e7ec; margin:0 0 8px}
  .muted{color:var(--muted)}
  .inputRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  input[type=text]{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid #2f3340; background:#0f1116; color:#fff; outline:none}
  .notice{margin-top:8px; font-weight:700}
  .ok{color:var(--ok)} .fail{color:var(--bad)}
  .foot{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:14px}
  .nextBtn{display:none}
  .nextBtn.show{display:inline-block}
  .progress{margin:8px 0 0; color:#bfc3ce; font-size:14px}
</style>
</head>
<body>
<header>
  <h1>Таинственный дом — Командный квест</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="teamTag" class="teamTag" aria-live="polite"></div>
    <button id="btnStart" class="btn primary" type="button">Старт</button>
    <button id="btnReset" class="btn secondary" type="button">Заново</button>
  </div>
</header>

<div class="wrap">
  <section id="intro" class="card">
    <div class="roomHero" style="background-image:url('door.png');"></div>
    <div class="roomBody">
      <p class="story">
        Этот дом стоит на холме уже сотни лет. Никто не помнит, кто и зачем его построил.
Но каждый Хэллоуин его окна загораются странным светом, а двери приоткрываются — будто зовут войти.
Только самые смелые решаются переступить порог.
Дом сам разделит вас на команды… и, возможно, именно вы откроете последнюю дверь.
      </p>
      <p class="muted">Нажмите «Старт», чтобы узнать, какая команда вам достанется.</p>
    </div>
  </section>

  <section id="teamScreen" class="card" style="display:none">
    <div class="roomHero" style="background-image:url('mirrors.png')"></div>
    <div class="roomBody" style="text-align:center">
      <div class="muted">Ваша команда</div>
      <div id="bigTeam" class="teamName">КОМАНДА</div>
      <p class="muted"> Найдите других членов вашей команды. Их помощь понадобится вам, одному в этом доме не справиться. Когда будете готовы — начинайте.</p>
      <button id="readyBtn" class="btn primary" type="button">Готовы</button>
    </div>
  </section>

  <section id="room" class="card" style="display:none" aria-live="polite">
    <div id="roomHero" class="roomHero"></div>
    <div class="roomBody">
      <h2 id="roomTitle" class="roomTitle"></h2>
      <p id="roomStory" class="story"></p>
      <div id="taskBox"></div>
      <div id="result" class="notice"></div>
      <div class="foot">
        <div id="progressText" class="progress">Комната 1 из 4</div>
        <button id="nextBtn" class="btn primary nextBtn" type="button">Дальше</button>
      </div>
    </div>
  </section>

  <section id="final" class="card" style="display:none">
    <div class="roomHero" style="background-image:url('door.png')"></div>
    <div class="roomBody">
      <h2 class="roomTitle">Дверь распахнулась!</h2>
      <p class="story">Дом принял вашу смелость и смекалку. Отличная работа, команда!</p>
      <p id="finalTeam" class="muted"></p>
      <button id="playAgain" class="btn secondary" type="button">Вернуться в меню</button>
    </div>
  </section>
</div>

<script>
const TEAMS = [
  { id:'ghosts',  name:'ПРИЗРАКИ', color:'ghost' },
  { id:'hunters', name:'ОХОТНИКИ', color:'hunters' }
];

const ROOMS = [
{
  key:'library',
  title:'Библиотека',
  img:'library.png',
  story:'Полки до потолка, карточный каталог и скрип перьевой ручки. В воздухе витает запах старых страниц и тайны. На столе записка: «Ключ — в первых буквах найденного».',
  render(container, helpers){
    const items = ['Кружка','Носок','Игрушка','Галстук','Альбом'];
    // случайная перестановка предметов
    const shuffled = items.sort(() => Math.random() - 0.5);

    container.innerHTML = `
      <p><b>Найдите и соберите перед собой эти 5 предметов (в любом порядке):</b></p>
      <ul id="itemList">${shuffled.map(it=>`<li>${it}</li>`).join('')}</ul>
      <button id="confirmItems" class="btn primary" style="margin-top:10px">Предметы собраны</button>
      <div id="stage2" style="display:none; margin-top:15px">
        <p class="muted">Первые буквы предметов образуют пароль. Введите его ниже:</p>
        <div class="inputRow">
          <input id="libAnswer" type="text" placeholder="введите пароль">
          <button id="libCheck" class="btn secondary">Проверить</button>
        </div>
      </div>
    `;

    const confirmBtn = container.querySelector('#confirmItems');
    const stage2 = container.querySelector('#stage2');
    const inp = container.querySelector('#libAnswer');
    const checkBtn = container.querySelector('#libCheck');

    confirmBtn.onclick = () => {
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Отлично! Теперь разгадайте, что означают эти предметы...';
      stage2.style.display = 'block';
    };

    checkBtn.onclick = () => {
      const val = (inp.value || '').trim().toUpperCase();
      if (val === 'КНИГА') helpers.check(true);
      else helpers.check(false);
    };
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') checkBtn.click(); });
  }
  },
  {
    key:'alchemy',
    title:'Комната 2. Алхимик — «Зелье спокойствия»',
    img:'alchemy.png',
    story:'Сияют колбы, пахнет чаем и специями. Дом ждёт, когда вы приготовите зелье вместе.',
    render(container, helpers){
      container.innerHTML = `
        <p><b>Сварите зелье «Спокойствия»:</b></p>
        <ol>
          <li>Кружка горячего <b>чая</b>.</li>
          <li>Добавьте <b>ягоды</b> или ложку варенья.</li>
          <li>Размешайте ложку <b>мёда</b>.</li>
          <li>Щепотка <b>корицы</b> или <b>имбиря</b>.</li>
          <li>Можно немного <b>молока</b>.</li>
        </ol>
        <button id="holdOk" class="btn primary">Ведущая подтверждает</button>`;
      const btn = container.querySelector('#holdOk');
      let t = null;
      btn.addEventListener('pointerdown', () => { t = setTimeout(() => helpers.check(true), 2000); });
      ['pointerup','pointerleave','pointercancel'].forEach(ev => btn.addEventListener(ev, () => clearTimeout(t)));
    }
  },
  {
    key:'mirrors',
    title:'Комната 3. Зал зеркал — «Эстафета отражений»',
    img:'mirrors.png',
    story:'Отражения множатся и ждут синхронности команды.',
    render(container, helpers){
      container.innerHTML = `
        <p><b>Задание:</b> первый игрок показывает короткий жест. Следующий повторяет и добавляет свой. Продолжайте до 5 жестов, выполните цепочку синхронно.</p>
        <button id="holdOk2" class="btn primary">Ведущая подтверждает</button>`;
      const btn = container.querySelector('#holdOk2');
      let t = null;
      btn.addEventListener('pointerdown', ()=>{ t=setTimeout(()=>helpers.check(true),2000); });
      ['pointerup','pointerleave','pointercancel'].forEach(ev=> btn.addEventListener(ev, ()=>clearTimeout(t)));
    }
  },
  {
    key:'door',
    title:'Финальная дверь — «Три замка»',
    img:'door.png',
    story:'На двери — три замка. Каждый ждёт своё слово. Обсудите вместе и откройте все.',
    render(container, helpers){
      container.innerHTML = `
        <p><b>Замок I:</b> «Без ног хожу, без языка говорю, за солнцем иду, ночью сплю. Кто я?»</p>
        <input id="z1" type="text" placeholder="(ж.р.)">
        <p><b>Замок II:</b> «Её не видно, но все чувствуют. Она согревает дом без огня. Что это?»</p>
        <input id="z2" type="text" placeholder="(ж.р.)">
        <p><b>Замок III:</b> «Она идёт вперёд, никогда не возвращается. Что это?»</p>
        <input id="z3" type="text" placeholder="(ср.р.)">
        <button id="doorCheck" class="btn secondary" style="margin-top:10px">Проверить</button>
        <div id="doorRes" class="notice"></div>`;
      const n=s=>(s||'').trim().toLowerCase().replaceAll('ё','е');
      $('#doorCheck').onclick=()=>{
        const a1=n($('#z1').value),a2=n($('#z2').value),a3=n($('#z3').value);
        if(a1==='тень'&&a2==='любовь'&&a3==='время') helpers.check(true);
        else $('#doorRes').textContent='Не все замки открылись. Попробуйте ещё раз!';
      };
    }
  }
];

const $=s=>document.querySelector(s);
const el={
  teamTag:$('#teamTag'),btnStart:$('#btnStart'),btnReset:$('#btnReset'),
  teamScreen:$('#teamScreen'),room:$('#room'),hero:$('#roomHero'),
  title:$('#roomTitle'),story:$('#roomStory'),task:$('#taskBox'),
  result:$('#result'),next:$('#nextBtn'),progress:$('#progressText'),
  final:$('#final'),finalTeam:$('#finalTeam'),playAgain:$('#playAgain')
};
let team=null,idx=0;

function applyTeam(t){
  team=t; localStorage.setItem('hn_team',JSON.stringify(t));
  el.teamTag.textContent=t.name; el.teamTag.className='teamTag '+t.color;
}
function pickTeam(){
  const t=TEAMS[Math.floor(Math.random()*TEAMS.length)];
  applyTeam(t); $('#bigTeam').textContent=t.name; $('#bigTeam').className='teamName '+t.color;
  $('#intro').style.display='none'; $('#teamScreen').style.display='';
}
function showRoom(){
  const r=ROOMS[idx]; if(!r)return showFinal();
  el.room.style.display=''; el.hero.style.backgroundImage=`url('${r.img}')`;
  el.title.textContent=r.title; el.story.textContent=r.story;
  el.task.innerHTML=''; el.result.textContent=''; el.next.classList.remove('show');
  el.progress.textContent=`Комната ${idx+1} из ${ROOMS.length}`;
  r.render(el.task,{check(ok){if(ok){el.result.textContent='✔ Верно!';el.result.className='notice ok';el.next.classList.add('show');}else{el.result.textContent='✖ Неверно.';el.result.className='notice fail';}}});
}
function nextRoom(){idx++;localStorage.setItem('hn_idx',idx);if(idx>=ROOMS.length)showFinal();else showRoom();}
function showFinal(){el.room.style.display='none';el.final.style.display='';el.finalTeam.textContent=`Команда: ${team?team.name:'—'}`;}
function resetAll(){localStorage.removeItem('hn_team');localStorage.removeItem('hn_idx');location.reload();}

el.btnStart.onclick=pickTeam;
$('#readyBtn').onclick=()=>{el.teamScreen.style.display='none';idx=0;showRoom();};
el.next.onclick=nextRoom;
el.btnReset.onclick=resetAll;

// 🔹 Новое поведение кнопки
el.playAgain.addEventListener('click', () => {
  window.location.href = "https://irinaburljaeva.github.io/halloweennight";
});
</script>
</body>
</html>
